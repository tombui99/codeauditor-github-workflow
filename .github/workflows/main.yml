name: CodeAuditor test

on:
  push:
    branches: [main]

# A workflow run is made up of one or more jobsjj that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: "SSW CodeAuditor - Check broken links and performance"
        continue-on-error: true
        run: |
          curl --request GET 'https://asia-east2-sswlinkauditor-c1131.cloudfunctions.net/api/comparescanlatestandsecond/3c34a549-dfb3-442c-b0e3-45942104a8bf/https%3A%2F%2Fwww.htmlhint.com%2F' -o content.json
      
      - name: read api content
        id: content
        run: echo "::set-output name=id::$(cat content.json)"

      - name: read content
        run: echo "${{fromJson(steps.content.outputs.id)}}"

      - name: If number of Code Warnings increases
        if: "${{fromJson(steps.content.outputs.id).isHtmlWarningsUp}}"
        env:
          GH_TOKEN: ${{secrets.GH_TOKEN}}
        run: |
          echo "Create issue for increased code warnings"
          gh issue create --title "Increased number of HTML Warnings detected!!!!" -- body "test"
      
      - name: If number of Code Errors increases
        if: "${{fromJson(steps.content.outputs.id).isHtmlErrorsUp}}"
        env:
          GH_TOKEN: ${{secrets.GH_TOKEN}}
        run: |
          echo "Create issue for increased code errors"
          gh issue create --title "Increased number of HTML Errors detected!!!!" -- body "test"

      - name: If number of Broken Links increases
        if: "${{fromJson(steps.content.outputs.id).isBrokenLinksUp}}"
        env:
          GH_TOKEN: ${{secrets.GH_TOKEN}}
        run: |
          echo "Create issue for increased broken links"
          gh issue create --title "Increased number of Broken 404 Links detected!!!!" -- body "test"
        
        # run: "docker run sswconsulting/codeauditor --token 3c34a549-dfb3-442c-b0e3-45942104a8bf --url htmlhint.com --private"
